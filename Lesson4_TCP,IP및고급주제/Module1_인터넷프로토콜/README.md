# 1. TCP/IP 아키텍처 및 IP 패킷
***
### Why Internetworking?
- TCP/IP Protocol Suite는 여러개의 공존하는 이기종 네트워크 기술을 통해 작동할 수 있는 네트워크, 인터넷 네트워크를 구축하는 것
- 목표는 IP 패킷 전송을 통해 유비쿼터스 연결을 제공하는 것
### TCP/IP Protocol Suite
- TCP/IP 프로토콜 스위트는 일반적으로 TCP(전송 제어 프로토콜), IP(인터넷 프로토콜) 뿐만 아니라 UDP(사용자 데이터그램 프로토콜), ICMP(인터넷 제어 메시지 프로토콜), ARP(주소 확인 프로토콜) 및 기타 응용 프로그램과 같은 프로토콜을 가리킴
### Encapsulation
- 주어진 계층의 프로토콜 데이터 단위는 아래 계층의 프로토콜 데이터 단위로 캡슐화됨
- HTTP 요청은 TCP 계층으로 전달되며, TCP 계층은 메시지를 TCP 세그먼트로 캡슐화함
- TCP 헤더에는 원본 및 대상 포트 번호가 포함됨
- TCP 세그먼트는 차례로 IP 계층으로 전달되어 IP 패킷에 캡슐화됨
- IP 캡슐 헤더에는 발신자의 IP 네트워크 주소와 목적지의 IP 네트워크 주소가 포함됨
- IP 패킷은 네트워크 인터페이스를 통해 전달됨
### Internet Addresses
- 인터넷의 각 호스트는 전 세계적으로 고유한 IP 주소로 식별됨
- IP 주소는 네트워크 ID와 호스트 ID의 두부분으로 나뉘어짐
- 라우팅 결정은 대상 IP 주소를 기반으로 이루어짐
### Internet Protocol
- 인터넷 프로토콜 (IP)은 전송 계층에 연결이 필요 없는 최선의 전송 서비스를 제공함
- 우리가 사용하려는 IP가 목적지로 패킷을 전달하는 것이 가장 좋지만, 패킷이 목적지로 전달된다는 보장이나 서비스 품질을 보장하지는 않는다
- 필요한 경우 상위 계층 프로토콜에서 안정성 문제를 해결해야 함
- 이러한 설계는 IP의 복잡성을 줄이고 유연성을 높임
### IP Packet Header
- IP 패킷에는 헤더 포트와 데이터 포트가 포함됨
- 헤더 포트의 형식은 ppt 그림 참고
- 헤더에는 20바이트의 고정 길이 구성 요소와 최대 40바이트까지 가능한 Options로 구성된 가변 길이 구성 요소가 있음
- Version 헤더
  - IP 패킷에서 사용하는 버전 번호(4 or 6)를 나타냄
- IHL
  - IP 헤더의 길이가 다를 수 있음 헤더 길이 필드는 헤더 길이를 32비트 워드로 지정함
- Type of Service
  - 서비스 유형 필드는 패킷의 품질을 지정함
- Total Length
  - 패킷의 데이터 양이 다를 수 있으므로 전체 길이 필드는 헤더와 데이터를 포함한 IP 패킷의 바이트 수를 지정함
  - 최대 길이인 64킬로바이트는 거의 사용되지 않음
  - 이더넷에서 페이로드 길이를 1500바이트로 제한하는 경우가 많기 때문
- Identification, Flags, Gragment Offset
  - 프래그먼트화 및 리어셈블리에 사용됨
- Time-to-Live
  - 패킷이 네트워크에 남아 있을 수 있는 시간을 초 단위로 나타내기 위해 정의됨
  - 라우터는 이 필드를 해석하여 네트워크에서 패킷이 통과할 수 있는 홉 수를 나타냄
  - 필드가 0에 도달하면 라우터는 패킷을 버림
  - 규모를 제한하고 플러딩으로 인한 중복 항목을 제거하는데 사용할 수 있음
- Protocol
  - 대상에서 IP 데이터를 수신하는 데 사용할 상위 계층 프로토콜을 지정함
- Header Checksum
  - IP 헤더의 무결성을 확인함
  - 데이터 부분은 검증되지 않았으며 상위 계층 프로토콜에 맡겨져 있다는 점 참고
- Source, Destination IP Address
  - 원본 및 대상 호스트의 주소가 포함됨
- Options
  - 가변 길이의 옵션 필드를 사용하면 패킷이 보안 수준, 취할 경로, 각 라우터의 타임스탬프와 같은 특수 기능을 요청할 수 있음
- Padding
  - 옵션이 길이가 가변적이므로 패딩을 사용하여 32비트 배수인 헤더를 만듬
### IP Header Processing
1. IP 패킷이 라우터로 전달되면 라우터는 헤더 체크섬의 정확성을 계산한 다음 헤더에서 해당 필드를 확인함. 예를 들어 버전 및 로그 전체 길이에는 유효한 값이 포함되어 있음
2. 라우터는 라우팅 테이블을 참조하여 IP 패킷의 다음 홉을 식별함
3. 라우터는 Time-to-Live 및 헤더 체크섬과 같은 필드를 변경하고 다음 홉을 따라 패킷을 전달함
***
# 2. IP 주소 지정
***
### IP Addressing
- IP 주소 구조는 네트워크 ID(netid)와 호스트 ID(hostid)라는 2가지 수준의 계층 구조를 갖도록 정의됨
- netid는 호스트가 연결된 네트워크를 식별함
- 사용자를 동일한 네트워크에 연결하는 모든 호스트는 동일한 네트워크 ID를 가짐
- hostid는 호스트에 대한 네트워크 연결을 식별하며, 이 집계는 패킷 라우팅을 용이하게 함
- 즉, 라우터는 네트워크 ID만을 기반으로 패킷을 전달하므로 라우팅 테이블의 크기가 크게 줄어듬
- hostid는 로컬 사이트의 네트워크 관리자가 할당함
- 조직의 netid는 인터넷 서비스 공급자가 할당할 수 있음
- IPv4는 점으로 구분된 십진수 표기법을 사용하는 경우가 많음
### Classful Addresses
- IP 주소 구조는 5개의 주소 클래스로 구분됨(클래스 A~E)
- Class A 주소는 netid 7비트, hostid 24비트로 네트워크당 최대 126개의 네트워크와 약 1600만개의 호스트를 허용
- Class B 주소는 netid 14비트, hostid 16비트로 구성되어 있어 네트워크당 최대 16,382개의 네트워크와 약 64,000개의 호스트를 허용
- Class C 주소는 netid 21비트, hostid 8비트로 구성되어 있어 네트워크당 2백만개의 네트워크와 254개의 호스트를 허용함
### Class D Addresses
- Class D 주소는 호스트 그룹에 정보를 동시에 보낼 수 있는 멀티캐스트 서비스에 이용됨
- 접두사 1110
- 멀티캐스트 주소에는 28비트가 있어 최대 약 2.5억개의 멀티캐스트 그룹을 사용할 수 있음
- Class E 주소는 실험에 사용
### Reserved Host IDs (all 0s & 1s)
- 이들은 모두 1이나 모두 0으로 구성된 ID를 특수 용도로 호스팅하는 데 사용됨
- 네트워크를 참조하는 데 사용되는 인터넷 주소의 호스트 ID는 모두 0으로 설정되어 있음
- 네트워크 ID로 지정된 네트워크의 모든 호스트에 패킷을 브로드캐스트하기 위한 모든 패킷을 포함하는 호스트 ID임
- 네트워크 ID에 모든 ID가 포함된 경우, 패킷은 로컬 네트워크에서 브로드캐스트됨
- A,B hostid가 256개가 아닌 254개의 호스트만 허용하는 이유임
### Private IP Addresses
- 이러한 주소는 사설 네트워크에서 사용하도록 지정된 특정 범위 또는 사설 IP 주소임, 개인 인터넷에서만 사용가능
- 공용 인터넷의 라우터는 이러한 주소가 포함된 패킷을 폐기함
- Network Address Translation (NAT, 네트워크 주소 변환)은 사설 IP 주소와 글로벌 IP 주소를 변환하는 데 사용됨
### Example of IP Addressing
### Subnets
- 원래 IP 주소 지정 체계의 클래스에는 단점이 있음
- Class A,B는 Class C와 비교해 너무 클 수 있음
- 약 64,000명의 호스트를 지원할 수 있는 Class B netid를 가진 일반적인 대학을 예
- 로컬 네트워크 관리자가 64,000개의 호스트를 모두 관리하는 것은 엄청난 작업임
- 일반적으로 대학에는 로컬 네트워크가 2개 이상 있음
- 예를 들어 한 학과에 로컬 네트워크가 하나 있을 수 있으므로 훨씬 많이 필요해짐
- 하나의 대규모 네트워크를 내부용으로는 여러개의 작은 부분으로 분할하면서도 오프사이트에서는 단일 네트워크처럼 작동하도록 하는 방법?
- 널리 사용되는 방법이 서브넷임
***
# 3. 서브넷팅
***
### Subnet Addressing
- 서브넷의 기본 개념은 서브넷이라는 또 다른 계층 수준을 추가하는 것임
- 서브넷 주소 지정의 장점은 조직 외부의 네트워크에서는 이를 인식하지 못한다는 것
- 조직 외부에 있는 호스트는 여전히 원래 주소 구조가 2단계로 되어 있는 것을 볼 수 있다는 것
- 조직 내부에서는 로컬 네트워크 관리자가 서브넷 및 호스트 id 필드에 대해 원하는 LAN 조합을 자유롭게 선택할 수 있음
- 이를 통해 조직 내 여러 LAN을 간편하게 관리할 수 있음
- 하지만 패킷이 기본 라우터로 들어오면, 어떤 서브넷에 패킷을 전달해야 하는지 어떻게 알 수 있을까?
- IP 주소 마스킹은 서브넷 ID를 찾는 데 사용됨
### Subnetting Scheme
- 서브넷 체계, 네트워크 ID가 155.100.0.0인 Class B 주소를 가진 조직을 예
- 네트워크의 호스트 ID는 16비트로 구성됨
- 한 조직에 각 서브넷에 100개 이하의 호스트로 구성된 근거리 통신망이 여러개 있다고 가정
- 호스트 ID의 7비트면 서브넷의 각 호스트를 고유하게 식별하는데 충분하며 2^7-2 126개 호스트로 가정하면 됨
- 나머지 9비트는 조직 내의 서브넷을 식별하는데 사용될 수 있으며, 조직 내에서 2^9-2의 510개의 서브넷을 식별할 수 있음
- 문제는 대상 IP 주소를 가진 패킷(ex : 155.100.12.176)이 외부 네트워크에서 사이트에 도착한 경우 라우터는 이 패킷을 어느 서브넷으로 전달해야 하는가
- 서브넷 번호를 찾으려면 라우터가 서브넷 마스크라는 추가 수량을 저장해야 함
- 서브넷 마스크는 2진수 마스크가 사용됨
- 서브넷 마스크는 2진수 0이 사용되는 호스트 ID 필드를 제외한 주소의 모든 비트 위치에 대해 2진수로 구성됨
- 호스트 ID에 7비트가 사용되므로 이진 문자열의 서브넷 마스크가 내부에 제공되는데, 이는 점으로 구분된 십진 표기법의 250.250.250.128에 해당함
- 라우터는 서브넷 마스크와 해당 IP 주소 사이에서 비트별로 완벽한 로직과 연산을 수행하여 서브넷 번호를 확인할 수 있음
- 결과 서브넷 번호는 점으로 구분된 십진수 표기법으로 150.100.12.128 로 표현
- 이 번호는 조직 내 올바른 서브넷으로 패킷을 전달하는데 사용됨
- 서브넷에서 더 많은 호스트를 지원해야 하는 경우 호스트 ID에는 더 많은 비트가 필요하지만 서브넷 ID에 남는 비트수는 줄어듬
### Subnet Range
- 서브넷 150.100.12.128에서, IP 주소 150.100.12.128은 서브네트워크를 식별하는 데 사용됨
- IP 주소 150.100.12.255는 서브넷의 패킷을 브로드캐스트하는데 사용됨
### Routing with Subnetworks
- 최종 시스템 호스트와 라우터의 IP 계층은 함께 작동하여 IP 네트워크 소스에서 목적지로 패킷을 라우팅함
- 각 호스트와 라우터의 IP 계층은 각 IP 패킷 처리 방법을 결정하는 데 사용되는 라우팅 테이블을 유지함
- 발신 호스트가 IP 패킷을 보내는 작업을 고려하여 라우팅 테이블을 참조함
- 대상 호스트가 동일한 네트워크에 있는 경우 적절한 네트워크 인터페이스를 사용하여 패킷을 직접 전송함
- 그렇지 않으면 일반적으로 라우팅 테이블은 패킷을 원본 호스트에 직접 연결된 기본 라우터로 보내도록 지정함
- 라우터가 IP 패킷을 수신하면 라우팅 테이블을 참조하여 도착 패킷의 IP 대상 주소를 검사함
- 패킷이 자신에게 전달되는 경우 패킷은 적절한 상위 계층 프로토콜로 전달됨
- 대상 IP 주소가 라우터의 자체 주소가 아닌 경우 라우터는 라우팅 테이블을 참조하여 다음 허브 및 관련 네트워크 인터페이스를 결정한 다음 패킷을 전달함
***
# 4. 서브넷 라우팅 예제
***
### Routing Table
- 라우터 또는 해당 호스트의 라우팅 테이블이 포함하고 있는 것
  - 목적지 IP 주소
  - next-hop 라우터의 IP 주소
  - 플래그 필드
  - 송신 네트워크 인터페이스의 물리적 주소 및 통계 정보
  - 여러 유형의 플래그
    - H 플래그 : 해당 역할의 경로가 호스트인지 네트워크인지 판별
    - G 플래그 : 지정 역할의 경로가 라우터 또는 직접 연결된 목적지로 향하는 경우
### Routing Search and Actions
- 패킷을 라우팅할 때마다 라우팅 테이블이 순서대로 검색됨
- 먼저 대상 열을 검색하여 테이블에 전체 대상 주소 항목이 포함되어 있는지 확인함
- 그렇다면 다음 홉 엔트리에 따라 IP 패킷이 전달됨
- 그렇지 않으면 라우팅 테이블에서 대상 네트워크 ID를 검색함
- 엔트리가 발견되면 다음 홉 엔트리에 따라 IP 패킷이 전달됨
- 위 방법으로 문제가 해결되지 않으면 테이블에서 기본 라우터 항목을 검색하고 사용할 수 있는 경우 패킷이 해당 항목으로 전달됨
- 마지막으로 위의 검색 중 아무 것도 성공하지 못하면 패킷은 배달 불가능으로 선언되고 ICMP 호스트 연결 불가 오류 패킷이 원래 호스트로 다시 전송됨
### Example 1 : A packet with 150.100.15.11 arrives at R1
- 기본 라우터 R1은 패킷을 전송할 다음 허브 라우터를 알아야 함
- IP 주소 150.100.15.11을 2진 문자열로 변환
- 라우터 R1은 9비트 서브넷 필드가 사용 중임을 알고 있으므로 호스트 ID의 기본 ID가 7개이므로 마스크를 가져옴
- 비트별 논리 AND 연산을 수행하여 마스크를 적용해 IP 주소에서 서브넷 주소로 추출
- 결과는 150.100.15.0
- 라우터 1은 라우팅 테이블에서 이 서브넷 번호를 조회하고 해당 항목을 찾아 라우터 R2의 다음 홉 라우터 주소인 150.100.12.1을 지정함
- R1은 단순히 패킷을 아티클 임포트 150.100.12.4에 넣음
- 브로드캐스트를 통해 R2는 동일한 네트워크에 있는 포트 150.100.12.1에서 패킷을 가져옴
- R2는 패킷을 수신할 때 동일한 프로세스를 수행하여 대상 호스트가 네트워크 인터페이스 중 하나에 연결되어 있음을 확인함
- 패킷을 목적지로 직접 전송
### Example 2 : Host H5 sends packet to host H2
- H2의 주소는 150.100.12.176
- 라우팅 테이블에서 첫번째 항목은 루프백 인터페이스이고 H는 호스트 주소를 나타냄
- 두번째 항목은 다음 홉 라우터 R2 150.100.15.54의 기본 항목
- 라우터이므로 플래그 비트 G는 1로 설정되고 넷 인터페이스 emd0를 사용함
- 일반적으로 next-hop 항목은 알고리즘 네트워크 인터페이스의 IP 주소임
- 호스트 H5는 먼저 라우팅 테이블에서 대상 주소 150.100.12.176의 IP 패킷을 검색함
- 라우팅 테이블에서 해당 항목을 찾을 수 없으므로 150.100.12.108인 대상 네트워크 ID를 검색함
- R2로의 기본 경로를 찾아 네트워크를 통해 IP 패킷을 전달함
- 라우터 R2는 라우팅 테이블을 검색하고 IP 패킷을 라우터 R1에 전달함
- R2는 기본 경로를 사용하여 라우팅 테이블을 검색하여 대상 네트워크 ID인 150.100.12.128과 일치하는 항목을 찾음
- 브로드캐스트를 통해 근거리 통신망에 패킷을 전달하는 네트워크 인터페이스가 패킷을 수신하고 호스트 H2가 패킷을 수신하도록 패킷을 전송함